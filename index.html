<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hallo sahabat </title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\', '\']]
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-blue-100 min-h-screen flex flex-col items-center justify-start">

  <!-- HERO SECTION -->
  <section class="w-full bg-gradient-to-r from-blue-600 to-blue-400 text-white py-8 px-4 shadow-md text-center">
    <div class="max-w-4xl mx-auto">
      <div class="flex flex-col items-center">
     <img src="gbr/bp.jpeg" alt="Logo" class="w-24 h-24 mb-4 object-contain">
       <p class="mt-2 text-lg">welcome</p>
        <h1 class="text-3xl font-bold">Portal Matematika</h1>
        <p class="mt-2 text-lg">uji kemampuanmu dengan soal-soal pilihan</p>
      </div>
    </div>
  </section>

  <!-- FORM LOGIN -->
  <div id="loginForm" class="bg-blue-100 p-8 rounded-2xl shadow-lg text-center transform transition-transform hover:scale-105 border-t-4 border-blue-400">
      <h2 class="text-3xl font-bold mb-6 text-blue-800">Login</h2>
    <input id="loginUsername" placeholder="Username" class="w-full mb-2 p-2 border rounded" />
    <input id="loginPassword" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded" />
    <button onclick="login()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Login</button>
    <p class="mt-4 text-sm">
  Belum punya akun? 
  <button onclick="showRegister()" class="text-blue-600 underline">Register</button>
  <button onclick="window.location.href='soal.html'" class="text-blue-800 underline ml-2">Demo</button>
</p>
    
  </div>
  
  
  
  

  <!-- FORM REGISTER -->
   <div id="registerForm" class="hidden bg-blue-100 p-8 rounded-2xl shadow-lg text-center transform transition-transform hover:scale-105 border-t-4 border-blue-400">
    <h2 class="text-2xl font-bold mb-4">Register</h2>
    <input id="regUsername" placeholder="Username" class="w-full mb-2 p-2 border rounded" />
    <input id="regEmail" placeholder="Email" class="w-full mb-2 p-2 border rounded" />
    <input id="regPassword" type="password" placeholder="Password" class="w-full mb-4 p-2 border rounded" />
    <button onclick="register()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Register</button>
    <p class="mt-4 text-sm">Sudah punya akun? <button onclick="showLogin()" class="text-blue-600 underline">Kembali ke Login</button></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden w-full max-w-2xl mx-auto pt-4 sticky top-0 bg-white z-10 shadow mt-6">
    <div class="flex justify-between items-center mb-4 px-4">
      <h2 id="welcome" class="text-xl font-semibold"></h2>
      <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <div id="selectContainer" class="px-4">
      <label class="block mb-2">Pilih kelas:</label>
      <select id="kelas" onchange="updateJenisSoal()" class="w-full p-2 border rounded mb-4">
        <option value="">-- Pilih Kelas --</option>
        <option value="x">X</option>
       <option value="xi">XI</option>
        <option value="xii">XII</option>
          <option value="all">ALL</option>
        
      </select>

      <label class="block mb-2">Pilih jenis soal:</label>
      <select id="jenisSoal" class="w-full p-2 border rounded mb-4">
        <option value="">-- Pilih Jenis Soal --</option>
      </select>

      <button onclick="loadSoal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full">Tampilkan Soal</button>
    </div>





    <div id="soalContainer" class="px-4 mt-4"></div>
  </div>
  
  
  
 
<div id="skorUser" class="mt-6 p-4 bg-gray-100 rounded"></div>
<div id="rekapPerUser" class="mt-6 p-4 bg-blue-100 rounded"></div>
<div id="rekapNilaiTotal" class="mt-6 p-4 bg-green-100 rounded"></div>
  <!-- FOOTER -->
  
  
  
  
  
 
</div>
<div id="topUpArea"></div>
  
  
  .
   <div id="topUpArea"></div>
  
  <footer class="mt-auto w-full bg-blue-600 text-white text-center py-4">
    <p>&copy; 2025 Irzal Achmad </p>
  </footer>


  <!-- SCRIPT FIREBASE DAN LOGIKA -->
  
  
  
  
  
  
  
  
  
  
  
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCu4GQa-EOaPhpQP_y_QcsJxs05adQU2-M",
      authDomain: "math314-app.firebaseapp.com",
      databaseURL: "https://math314-app-default-rtdb.firebaseio.com",
      projectId: "math314-app",
      storageBucket: "math314-app.appspot.com",
      messagingSenderId: "9019551034",
      appId: "1:9019551034:web:de0c5e2b8b20c18ca0b403",
      measurementId: "G-VWYDTY9LF6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const jenisSoalMap = {
     x: ['trigonometri','statistik'],
     xi: ['peluang', 'regresi'],
    xii: ['integral', 'deferensial'],
 all: ['bilangan berpangkat',
     'pertidaksamaan',
    'SPTLTV', 
    'persamaan kuadrat',
    'persamaan eksponen', 
    'barisan dan deret',
    'statistik',
    'integral', 
    'matrik', 
    'fungsi komposisi dan invers',
    'transformasi', 
    'lingkaran',
    'vektor', 
    'logika matematika',
    'aritmatika sosial', 
    'program linier',
      'limit', 
      'deferensial',
    'integral'],
    };

    function showRegister() {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("registerForm").classList.remove("hidden");
    }

    function showLogin() {
      document.getElementById("registerForm").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
    }

   async function register() {
  const username = regUsername.value;
  const email = regEmail.value;
  const password = regPassword.value;

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = userCred.user.uid;

    await db.ref("data_siswa/" + uid).set({
      username,
      email,
      expired_at: new Date().toISOString().slice(0, 10),
      nilai: {},
      total_nilai: 0,
      approved: false
    });

    await db.ref("username_map/" + username).set(email);
    alert("Registrasi berhasil!");
    showLogin();

    // Tampilkan tombol bayar
    const bayarButton = document.createElement("button");
bayarButton.textContent = "scan qris";
bayarButton.style.marginTop = "10px";
bayarButton.style.padding = "10px 20px";
bayarButton.style.backgroundColor = "#4CAF50";
bayarButton.style.color = "white";
bayarButton.style.border = "none";
bayarButton.style.borderRadius = "5px";
bayarButton.style.cursor = "pointer";

document.body.appendChild(bayarButton); // Atau kamu bisa append ke div tertentuertentu

  } catch (err) {
    alert("Gagal registrasi: " + err.message);
  }
}

// Fungsi bayar (placeholder)

// Fungsi bayar yang bisa Anda sesuaikan dengan Midtrans atau lainnya
function bayar(uid, username) {
  alert(`Memulai proses pembayaran untuk ${username} (${uid})`);
  // Tambahkan logika Midtrans Snap atau lainnya di sini
}
    function logout() {
      auth.signOut();
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("loginUsername").value = "";
      document.getElementById("loginPassword").value = "";
    }

    function updateJenisSoal() {
      const kelas = document.getElementById("kelas").value;
      const jenisSelect = document.getElementById("jenisSoal");
      jenisSelect.innerHTML = '<option value="">-- Pilih Jenis Soal --</option>';

      if (kelas && jenisSoalMap[kelas]) {
        jenisSoalMap[kelas].forEach(jenis => {
          const opt = document.createElement("option");
          opt.value = jenis;
          opt.textContent = jenis.charAt(0).toUpperCase() + jenis.slice(1);
          jenisSelect.appendChild(opt);
        });
      }
    }





  </script>

<script>
  // Variabel global
  let currentUid = "";
  let currentUsername = "";

  // LOGIN
  async function login() {
    const username = loginUsername.value.trim();
    const password = loginPassword.value;

    try {
      const snap = await db.ref("username_map/" + username).get();
      if (!snap.exists()) throw new Error("Username tidak ditemukan");

      const email = snap.val();
      const userCred = await auth.signInWithEmailAndPassword(email, password);
      const uid = userCred.user.uid;

      const userSnap = await db.ref("data_siswa/" + uid).get();
      const userData = userSnap.val();

      if (!userData) throw new Error("Data pengguna tidak ditemukan");

      if (!userData.approved) {
        const topUpArea = document.getElementById("topUpArea");
        topUpArea.innerHTML = `
          <div class="max-w-md mx-auto mt-6 p-4 border border-yellow-400 bg-yellow-100 text-yellow-800 rounded-lg text-center">
            <p class="mb-4">Akun Anda belum diaktif. Silakan isi saldo Rp 10.000/bulan untuk berlangganan.</p>
            <button id="topUpButton" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded">
              Top Up Sekarang
            </button>
          </div>`;
        document.getElementById("topUpButton").onclick = () => bayar(uid, username);
        await auth.signOut();
        return;
      }

      currentUid = uid;
      currentUsername = username;

      document.getElementById("welcome").innerText = `Halo, ${username}`;
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");

    } catch (err) {
      alert("Login gagal: " + err.message);
    }
  }

  // LOAD SOAL
  async function loadSoal() {
    if (!currentUid) return alert("Anda harus login dulu.");

    const jenis = document.getElementById("jenisSoal").value;
    if (!jenis) return alert("Silakan pilih jenis soal.");

    const soalSnap = await db.ref("soal/" + jenis).get();
    if (!soalSnap.exists()) return alert("Soal tidak ditemukan.");

    const container = document.getElementById("soalContainer");
    container.innerHTML = "";

    const soalData = soalSnap.val();
    for (let key in soalData) {
      const soal = soalData[key];
      const div = document.createElement("div");
      div.innerHTML = `<h3 class="font-bold mb-2">${soal.pertanyaan}</h3>`;
      soal.pilihan.forEach((pil, i) => {
        div.innerHTML += `
          <label class="block">
            <input type="checkbox" name="${key}" value="${i}" class="mr-2">
            ${pil.teks}
          </label>`;
      });
      container.appendChild(div);
    }

    const skorBtn = document.createElement("button");
    skorBtn.textContent = "Cek & Simpan Skor";
    skorBtn.className = "mt-4 px-4 py-2 bg-blue-500 text-white rounded";
    container.appendChild(skorBtn);

    const today = new Date().toISOString().split("T")[0];
    const userRef = db.ref("data_siswa/" + currentUid);
    const userSnap = await userRef.get();
    const userData = userSnap.exists() ? userSnap.val() : {};
    const lastKey = "last_" + jenis;

    if (userData[lastKey] === today) {
      skorBtn.disabled = true;
      skorBtn.textContent = "Sudah dikerjakan hari ini";
    }

    skorBtn.onclick = async () => {
      let benar = 0;
      let total = Object.keys(soalData).length;

      for (let key in soalData) {
        const benarIndex = soalData[key].pilihan
          .map((p, i) => p.benar ? i.toString() : null)
          .filter(i => i !== null);
        const dipilih = [...document.querySelectorAll(`input[name='${key}']:checked`)].map(i => i.value);
        if (JSON.stringify(dipilih.sort()) === JSON.stringify(benarIndex.sort())) {
          benar++;
        }
      }

      const skor = benar / total;
      const skorKey = "nilai_" + jenis;
      const skorLama = userData[skorKey] ?? 0;

      if (skor > skorLama) {
        await userRef.update({
          [skorKey]: skor,
          [lastKey]: today
        });
        alert(`Skor ${skor} disimpan.`);
      } else {
        alert(`Skor ${skor} tidak disimpan karena lebih rendah atau sama.`);
      }

      skorBtn.disabled = true;
    };

    // Tampilkan skor user per jenis soal
    const skorDiv = document.getElementById("skorUser");
    if (userSnap.exists()) {
      const data = userSnap.val();
      const skorList = Object.keys(data)
        .filter(k => k.startsWith("nilai_"))
        .map(k => {
          const j = k.replace("nilai_", "");
          return `<li>${j}: ${data[k]}</li>`;
        });
        
        
        
        
        
      skorDiv.innerHTML = `<h4 class="font-bold mb-2">Skor Kamu:</h4><ul class="list-disc pl-5">${skorList.join("")}</ul>`;
    } else {
      skorDiv.innerHTML = `<p>Kamu belum punya skor yang tersimpan.</p>`;
    }





    // Rekap semua user
const semuaUser = await db.ref("data_siswa").get();
const rekapNilaiTotalDiv = document.getElementById("rekapNilaiTotal");

if (semuaUser.exists()) {
  const semuaData = semuaUser.val();
  const rekapTotal = [];

  for (let uid in semuaData) {
    const user = semuaData[uid];
    let total = 0;

    // Menjumlahkan semua nilai yang diawali dengan "nilai_"
    for (let key in user) {
      if (key.startsWith("nilai_") && typeof user[key] === "number") {
        total += user[key];
      }
    }

    if (user.username) {
      rekapTotal.push({ username: user.username, total });
    }
  }

  // Urutkan dari nilai tertinggi ke terendah
  rekapTotal.sort((a, b) => b.total - a.total);

  // Buat HTML-nya
  const isi = rekapTotal
    .map(u => `<li>${u.username}: ${u.total.toFixed(2)}</li>`)
    .join("");

  rekapNilaiTotalDiv.innerHTML = `
    <h4 class="font-bold mb-2">Total Skor Semua Siswa:</h4>
    <ul class="list-decimal pl-5">${isi}</ul>
  `;
} else {
  rekapNilaiTotalDiv.innerHTML = "<p>Tidak ada skor total ditemukan.</p>";
}
    // Render MathJax
    if (window.MathJax) {
      MathJax.typesetPromise()
        .then(() => console.log("Soal berhasil dirender dengan MathJax."))
        .catch((err) => console.error("Gagal render MathJax:", err));
    }
  }
</script>



</body>
</html>